<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar Dashboard | نظام الرصد الذكي</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    
    <style>
        :root { --primary: #00f2ff; --danger: #ff003c; --bg-dark: #050a0f; --panel-bg: rgba(10, 20, 30, 0.95); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-dark); color: white; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        #top-header { background: rgba(0, 0, 0, 0.9); border-bottom: 2px solid var(--primary); padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 1001; }
        .logo { font-family: 'Orbitron', sans-serif; color: var(--primary); font-weight: bold; font-size: 1.1rem; }

        #dashboard { display: flex; flex: 1; overflow: hidden; }
        #map { flex: 1; background: #0b0e14; }

        #news-panel { width: 380px; background: var(--panel-bg); border-right: 1px solid rgba(0, 242, 255, 0.2); display: flex; flex-direction: column; z-index: 1000; }
        .panel-header { padding: 15px; background: linear-gradient(90deg, var(--primary), transparent); font-weight: bold; color: black; }
        #news-container { flex: 1; overflow-y: auto; padding: 12px; }

        .news-card { background: rgba(255, 255, 255, 0.03); border-right: 4px solid var(--primary); margin-bottom: 10px; padding: 12px; border-radius: 4px; cursor: pointer; transition: 0.2s; text-decoration: none; color: white; display: block; }
        .news-card:hover { background: rgba(0, 242, 255, 0.1); transform: scale(1.02); }
        .news-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; }
        .news-meta { font-size: 0.7rem; color: var(--primary); opacity: 0.7; }

        /* ستايل الأيقونات المخصصة على الخريطة */
        .map-icon {
            display: flex; justify-content: center; align-items: center;
            background: rgba(255, 0, 60, 0.2); border: 2px solid var(--danger);
            border-radius: 50%; color: white; font-size: 14px;
            box-shadow: 0 0 10px var(--danger);
        }

        .status-dot { width: 8px; height: 8px; background: var(--danger); border-radius: 50%; display: inline-block; margin-left: 8px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <header id="top-header">
        <div class="logo">RADAR AI MONITORING <span class="status-dot"></span></div>
        <div id="stats">العمليات الميدانية: <span id="count" style="color:var(--primary)">0</span></div>
    </header>

    <div id="dashboard">
        <div id="map"></div>
        <aside id="news-panel">
            <div class="panel-header">تغذية البيانات الذكية</div>
            <div id="news-container"></div>
        </aside>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSwHGhFEF1yL4wxSzY3tlFFIPIvjLDkEfTrQwg4dQgr3IJNzwBANp7QOS5gkQthMnKwgfExwt_gL1Lu/pub?output=csv';

        const map = L.map('map', { zoomControl: false }).setView([20, 10], 3);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        let markersLayer = L.layerGroup().addTo(map);

        // --- دالة تحديد الأيقونة بناءً على الكلمات المفتاحية ---
        function getIconByContent(title) {
            let icon = "fa-circle"; // الافتراضي
            let color = "#ff003c";

            if (title.includes("انفجار") || title.includes("قصف")) icon = "fa-burst";
            else if (title.includes("طيران") || title.includes("مسيرة")) icon = "fa-plane-up";
            else if (title.includes("اشتباك") || title.includes("تحركات")) icon = "fa-gun";
            else if (title.includes("حريق")) icon = "fa-fire";
            else if (title.includes("تظاهر") || title.includes("احتجاج")) icon = "fa-users";

            return L.divIcon({
                html: `<div class="map-icon"><i class="fa-solid ${icon}"></i></div>`,
                className: '',
                iconSize: [30, 30]
            });
        }

        function updateData() {
            Papa.parse(csvUrl, {
                download: true, header: true,
                complete: function(results) {
                    const data = results.data.filter(row => row.Title && row.Latitude);
                    renderSystem(data);
                }
            });
        }

        function renderSystem(items) {
            const container = document.getElementById('news-container');
            document.getElementById('count').innerText = items.length;
            container.innerHTML = ''; 
            markersLayer.clearLayers();

            [...items].reverse().forEach((item) => {
                const lat = parseFloat(item.Latitude);
                const lon = parseFloat(item.Longitude);

                if (!isNaN(lat) && !isNaN(lon)) {
                    const markerIcon = getIconByContent(item.Title);
                    const marker = L.marker([lat, lon], { icon: markerIcon }).addTo(markersLayer);
                    marker.bindPopup(`<div style="direction:rtl"><b>${item.Title}</b></div>`);
                }

                const card = document.createElement('div');
                card.className = 'news-card';
                card.innerHTML = `
                    <div class="news-title">${item.Title}</div>
                    <div class="news-meta">الموقع: ${lat.toFixed(2)}, ${lon.toFixed(2)}</div>
                `;
                card.onclick = () => map.flyTo([lat, lon], 8);
                container.appendChild(card);
            });
        }

        setInterval(updateData, 30000);
        updateData();
    </script>
</body>
</html>
